{# templates/formulaire/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Formulaire index{% endblock %}
{% block stylesheets %}
    <link href="{{ asset('css/index.css') }}" rel="stylesheet">
{% endblock %}
{% block body %}
{% include 'navbar.html.twig' %}
    <main id="mainContent">
        <h1 style="text-align: center;">Les formulaires</h1>
        {# Форма фильтрации и поиска #}
        {% if 'ROLE_STAGIAIRE' not in app.user.roles %}
            <div class="card mb-4" id="filter-card">
                <div class="card-header" id="cardHeader">
                    <h5 class="card-title mb-0">Filtres et recherche</h5>
                </div>
                <div class="card-body" id="filter-card-body">
                    {{ form_start(filterForm, {'attr': {'class': 'row g-3', 'id': 'filter-form'}}) }}
                        <span class="col-12 col-md-2 col-xl-2 d-flex align-items-center fit-content">
                            <span><strong>Stagiaire:</strong></span>
                            <span>
                                {{ form_widget(filterForm.studentName, {'attr': {'class': 'form-control fit-content'}}) }} 
                            </span>
                        </span>
                        <span class="col-md-2 d-flex align-items-center mdHide fit-content">
                            <span><strong>Date début:</strong></span>
                            <span>
                                {{ form_row(filterForm.startDateFrom) }}
                            </span>
                        </span>
                        <span class="col-md-2 d-flex align-items-center mdHide fit-content">
                            <span><strong>Date fin:</strong></span>
                            <span>
                                {{ form_row(filterForm.startDateTo) }}
                            </span>
                        </span>
                        <span class="col-md-2 d-flex align-items-center mdHideFiltre fit-content">
                            <span><strong>Trier par:</strong></span>
                            <span>
                                {{ form_row(filterForm.sortBy) }}
                            </span>
                        </span>
                        <span class="col-12 col-md-2 col-xl-2 d-flex align-items-center justify-content-center" id="btnFilterArea">
                            {{ include('components/filter_button.html.twig') }}
                            {{ include('components/reset_button.html.twig') }}
                        </span>
                        <div class="alert-info col-12 col-md-2 col-xl-2 d-flex align-items-center" id="result-count">
                            <strong>{{ formulaires.getTotalItemCount }} &#8203; </strong> resultats:
                        </div>
                    {{ form_end(filterForm) }}
                </div>
            </div>
        {% endif %}
        {# Таблица с данными #}
            <div class="container-fluid px-0">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="table">
                        <thead class="table-dark">
                            <tr>
                                <th>Id</th>
                                <th>Stagiaire</th>
                                <th>Qualité de stagiaire</th>
                                <th>Date de début de stage</th>
                                <th>Date de fin de stage</th>
                                <th>Chef de section</th>
                                <th>Formateur de stagiaire</th>
                                <th>Progression</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for formulaire in formulaires %}
                                <tr>
                                    <td id="id-start">{{ formulaire.id }}</td>
                                    <td id="name-start">{{ formulaire.getStudentFullName() }}</td>
                                    <td id="quality-start">{{ formulaire.Quality }}</td>
                                    <td id="startD-start">{{ formulaire.StartDate ? formulaire.StartDate|date('d-m-Y') : '' }}</td>
                                    <td id="endD-start">{{ formulaire.EndDate ? formulaire.EndDate|date('d-m-Y') : '' }}</td>
                                    <td id="advisor-start">{{ formulaire.TrainingAdvisor }}</td>
                                    <td id="trainer-start">{{ formulaire.TrainerOfIntern }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;" title="Progression des signatures">
                                            <div class="progress-bar 
                                                {% if formulaire.getSigningProgress() == 100 %}bg-success
                                                {% elseif formulaire.getSigningProgress() >= 50 %}bg-info
                                                {# {% elseif formulaire.getSigningProgress() == 0 %}bg-danger #}
                                                {% else %}bg-warning{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ formulaire.getSigningProgress() }}%;"
                                                aria-valuenow="{{ formulaire.getSigningProgress() }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                                {{ formulaire.getSigningProgress() }}%
                                            </div>
                                        </div>
                                        {# Детальная информация при наведении (опционально) #}
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            {% set status = formulaire.getSigningStatus() %}
                                            Stag: {% if status.student %}✔️{% else %}❌{% endif %} |
                                            Ent: {% if status.society %}✔️{% else %}❌{% endif %}
                                            Cmd: {% if status.commandant %}✔️{% else %}❌{% endif %} |
                                            Dir: {% if status.director %}✔️{% else %}❌{% endif %} 
                                        </small>
                                    </td>
                                    <td>
                                        <div class="btnsArea" role="group">
                                            {{ include('components/look_button.html.twig') }}
                                            {% if 'ROLE_COMMANDANT' not in app.user.roles %}
                                                {{ include('components/edit_button.html.twig') }}
                                                {{ include('components/_delete_form.html.twig') }}
                                            {% endif %}
                                            {{ include('components/pdf_button.html.twig') }}
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="14" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <br>
                                        Aucun document trouvé
                                        {% if isFilterSubmitted %} {# Используем переменную из контроллера #}
                                            <a href="{{ path('app_formulaire_index') }}">Réinitialiser les filtres</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div> 
        {# Пагинация #}
        <div class="navigation">
            {{ knp_pagination_render(formulaires) }}
        </div>
        {% if not is_granted('ROLE_COMMANDANT') and not is_granted('ROLE_DIRECTOR') %}
            {{ include('components/add_button.html.twig') }}
        {% endif %}
        {{ include('components/up_button.html.twig') }}
    </main>
<script>
    document.getElementById('btnUpId').addEventListener('click', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
{% endblock %}