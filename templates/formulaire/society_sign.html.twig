<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous"> #}
    <title>Signature - {{ formulaire.SocietyName }}</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; text-align: center; }
        canvas { border: 2px solid #333; margin: 20px 0; background-color: #fff; touch-action: none; }
        {# button { padding: 10px 20px; margin: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; } #}
        {# button:hover { background-color: #45a049; } #}
        {# .clear-btn { background-color: #f44336; } #}
        {# .clear-btn:hover { background-color: #d32f2f; } #}
        .flash-messages { margin: 20px 0; }
        .alert-error { 
            background-color: #ffebee; 
            color: #c62828; 
            padding: 10px; 
            border-radius: 4px; 
            border-left: 4px solid #c62828;
        }
        .btnsAreaSignatureSociety{
            display:flex;
            justify-content: center;
            align-items:center;
            height: 100%;
            width: 100%;
        }
        .saveSignature{
            display: flex;
            color: rgb(0, 0, 0);
            border: 2px solid transparent;
            background-color: #c0e779;
            border-radius: 100px;
            text-align: center;
            padding: 11px 11px 11px 11px;
            font-size: 1.4em;
            cursor: pointer;
            transition: border 0.5s ease;
        }
        .saveSignature:hover{
            border: 2px solid black;
        }
        .cleanSignature{
            display: flex;
            color: rgb(0, 0, 0);
            border: 2px solid transparent;
            background-color: #d4d2d2;
            border-radius: 100px;
            text-align: center;
            padding: 11px 11px 11px 11px;
            font-size: 1.4em;
            cursor: pointer;
            transition: border 0.5s ease;
            margin-right: 5px;
        }
        .cleanSignature:hover{
            border: 2px solid black;
        }
    </style>
</head>
<body>
    <h1>Signature √©lectronique</h1>
    <div class="actions">
            <a href="{{ path('app_formulaire_pdf', {'id': formulaire.id}) }}" target="_blank" class="btn btn-pdf">
                üìÑ Etudier le PDF
            </a>
        </div>
    <p>Veuillez signer la convention de stage pour <strong>{{ formulaire.SocietyName }}</strong>.</p>
    <p>Stagiaire: <strong>{{ formulaire.student ? formulaire.student.getLastname() ~ ' ' ~ formulaire.student.getFirstname() : 'N/A' }}</strong></p>

    {# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö #}
    {% for message in app.flashes('error') %}
        <div class="flash-messages">
            <div class="alert-error">{{ message }}</div>
        </div>
    {% endfor %}

    <canvas id="signatureCanvas" width="275%" height="200%"></canvas>
    <br>
    {# <button onclick="clearSignature()" class="cleanSignature" title="Effacer">Effacer</button> #}
    <div class="btnsAreaSignatureSociety">
        <button onclick="clearSignature()" class="cleanSignature" title="Effacer"><ion-icon name="refresh-outline"></ion-icon></button>
        <form method="POST" class="signature-form">
            <input type="hidden" name="signature" id="signatureInput">
            <button type="button" onclick="prepareAndSubmit()" class="saveSignature" title="Signer et Valider"><ion-icon name="checkmark-done-outline"></ion-icon></button>
        </form>
    </div>
    <script>
        // JavaScript –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∏—Å—Ç–∏
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#000000';
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        
        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        // –°–æ–±—ã—Ç–∏—è –¥–ª—è –º—ã—à–∏
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // –°–æ–±—ã—Ç–∏—è –¥–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            startDrawing({
                offsetX: touch.clientX - rect.left,
                offsetY: touch.clientY - rect.top
            });
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            draw({
                offsetX: touch.clientX - rect.left,
                offsetY: touch.clientY - rect.top
            });
        });
        
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);
        
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function prepareAndSubmit() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let isEmpty = true;
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] !== 0) {
                    isEmpty = false;
                    break;
                }
            }
            
            if (isEmpty) {
                alert("Veuillez apposer votre signature avant de valider.");
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–ø–∏—Å—å –≤ hidden input
            const dataURL = canvas.toDataURL();
            document.getElementById('signatureInput').value = dataURL;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            document.querySelector('form').submit();
        }
    </script>
    {# <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script> #}
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>